<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiches para Redes Sociales</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Poppins, sans-serif;
            background:#CAF0F8;
        }
        .sidebar {
            position: fixed;
            left:0;
            top:0;
            width:300px;
            height:100vh;
            background:#03045E;
            color:white;
            padding:25px;
        }
        .sidebar-item {
            padding:10px 15px;
            background:rgba(255,255,255,0.1);
            border-radius:8px;
            margin-bottom:10px;
            cursor:pointer;
            transition:0.2s;
        }
        .sidebar-item:hover {
            background:#0077B6;
        }
        .content {
            margin-left:330px;
            padding:30px;
        }
        #resultado {
            background:white;
            border-radius:14px;
            min-height:120px;
            border:1px solid #90E0EF;
            padding:20px;
            white-space:pre-wrap;
            line-height:1.6;
        }
    </style>
</head>

<body>

<div class="sidebar">
       <div class="sidebar-item" onclick="window.location.href='../dashboard.html'">
    Dashboard
</div>
<hr>
    <h2 class="fw-bold mb-4">Historial</h2>
    <div id="historial-list"></div>
</div>

<div class="content">

    <!-- <a href="dashboard.html" class="btn btn-sm mb-3" 
       style="background:#00B4D8;color:white;border-radius:8px;">‚Üê Volver</a> -->

    <h2 class="fw-bold mb-4" style="color:#03045E;">Afiches para Redes Sociales</h2>

    <div class="card p-4 shadow-sm" style="border-radius:18px">

        <div class="row g-4">

            <div class="col-md-6">
                <label class="fw-bold mb-1">Producto</label>
                <select id="select-productos" class="form-select">
                    <option value="">Cargando...</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="fw-bold mb-1">Edad objetivo</label>
                <select class="form-select filtro">
                    <option>18‚Äì25</option>
                    <option>25‚Äì35</option>
                    <option>35‚Äì50</option>
                    <option>50+</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="fw-bold mb-1">G√©nero</label>
                <select class="form-select filtro">
                    <option>Mixto</option>
                    <option>Masculino</option>
                    <option>Femenino</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="fw-bold mb-1">Intereses</label>
                <select class="form-select filtro">
                    <option>Fitness</option>
                    <option>Salud</option>
                    <option>Tecnolog√≠a</option>
                    <option>Bienestar</option>
                    <option>Ahorro</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="fw-bold mb-1">Objetivo del anuncio</label>
                <select class="form-select filtro">
                    <option>Aumentar ventas</option>
                    <option>Posicionamiento</option>
                    <option>Tr√°fico</option>
                    <option>Promoci√≥n</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="fw-bold mb-1">Estilo visual</label>
                <select class="form-select filtro">
                    <option>Moderno</option>
                    <option>Minimalista</option>
                    <option>Elegante</option>
                    <option>Colorido</option>
                    <option>Fotogr√°fico</option>
                </select>
            </div>

            <div class="col-md-12">
                <label class="fw-bold mb-1">Tono del mensaje</label>
                <select class="form-select filtro">
                    <option>Impactante</option>
                    <option>Emocional</option>
                    <option>Informativo</option>
                    <option>Persuasivo</option>
                    <option>Premium</option>
                </select>
            </div>

            <div class="col-12">
                <label class="fw-bold mb-1">Requerimientos adicionales</label>
                <textarea id="descripcion" rows="4" class="form-control"></textarea>
            </div>

        </div>

        <hr>

        <button id="btn-generar" class="btn text-white" style="background:#0077B6">
            Generar afiche
        </button>
<button id="btn-generar-imagen" 
        class="btn mt-3 text-white" 
        style="background:#00B4D8;border:none;">
    Generar afiche visual üé®
</button>
<div id="mensaje-afiche-visual" class="mt-2" style="color:#0077B6; display:none;">
    Generando afiche visual...
</div>
<div id="imagen-afiche" class="mt-4" style="display:none;">
    <img id="img-resultado" src="" class="img-fluid rounded shadow">
    <a id="btn-descargar" class="btn btn-success mt-3" download>Descargar imagen</a>
</div>

        <div id="resultado" class="mt-4" style="display:none;"></div>

        <button id="btn-copiar" class="btn mt-3" 
            style="background:#90E0EF;display:none;color:#03045E;border:none">
        Copiar texto</button>

    </div>

</div>

<script type="module">
/* =======================================
   CARGAR PRODUCTOS
======================================= */
document.addEventListener("DOMContentLoaded", async () => {
    const select = document.getElementById("select-productos");

    const res = await fetch("http://localhost:4000/api/productos");
    const productos = await res.json();

    select.innerHTML = "<option value=''>Seleccione...</option>";
    productos.forEach(p => {
        select.innerHTML += `<option value="${p._id}">${p.nombre}</option>`;
    });
});
</script>

<script type="module">
/* =======================================
   GENERAR AFICHE
======================================= */
document.addEventListener("DOMContentLoaded", () => {

    const btn = document.getElementById("btn-generar");
    const resultado = document.getElementById("resultado");
    const filtros = document.querySelectorAll(".filtro");

    btn.addEventListener("click", async () => {

        const data = {
            producto: document.getElementById("select-productos").selectedOptions[0].text,
            edad: filtros[0].value,
            genero: filtros[1].value,
            intereses: filtros[2].value,
            objetivo: filtros[3].value,
            estilo: filtros[4].value,
            tono: filtros[5].value,
            descripcion: document.getElementById("descripcion").value
        };

        resultado.style.display = "block";
        resultado.innerHTML = "<em style='color:#0077B6'>Generando contenido...</em>";

        const res = await fetch("http://localhost:4000/api/crear-afiche", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });

        const out = await res.json();
        const texto = out.resultado;

        resultado.innerHTML = "";
        let i = 0;

        (function escribir() {
            if (i < texto.length) {
                resultado.innerHTML += texto.charAt(i);
                i++;
                setTimeout(escribir, 12);
            }
        })();
    });
});
</script>

<script type="module">
/* =======================================
   COPIAR TEXTO
======================================= */
document.addEventListener("DOMContentLoaded", () => {

    const btn = document.getElementById("btn-copiar");
    const resultado = document.getElementById("resultado");

    const observer = new MutationObserver(() => {
        if (resultado.innerText.trim().length > 0) {
            btn.style.display = "inline-block";
        }
    });

    observer.observe(resultado, {childList: true, subtree: true});

    btn.addEventListener("click", async () => {
        await navigator.clipboard.writeText(resultado.innerText);
        btn.innerHTML = "Copiado ‚úî";
        setTimeout(() => btn.innerHTML = "Copiar texto", 2000);
    });

});
</script>

<script type="module">
document.addEventListener("DOMContentLoaded", async () => {

    const cont = document.getElementById("historial-list");
    const resultado = document.getElementById("resultado");

    const res = await fetch("http://localhost:4000/api/historial-afiches");
    const historial = await res.json();

    if (!historial.length) {
        cont.innerHTML = "<p class='text-white-50'>Sin historial</p>";
        return;
    }

    historial.forEach(item => {
        const resumen = JSON.stringify(item.busqueda).slice(0, 40) + "...";

        const div = document.createElement("div");
        div.className = "sidebar-item";
        div.innerHTML = `<strong>Afiche</strong><br><small>${resumen}</small>`;

        div.addEventListener("click", () => {
            resultado.style.display = "block";
            resultado.innerText = item.resultado;
        });

        cont.appendChild(div);
    });
});
</script>

<script type="module">
document.getElementById("btn-generar-imagen")
.addEventListener("click", async () => {

    const mensaje = document.getElementById("mensaje-afiche-visual");
    mensaje.style.display = "block"; // mostrar mensaje

    const resultado = document.getElementById("resultado").innerText;

    if (!resultado) {
        alert("Primero debes generar el contenido del afiche.");
        mensaje.style.display = "none"; // ocultar mensaje si no hay resultado
        return;
    }

    // Extraer textos clave desde el resultado IA
    const lineas = resultado.split("\n").map(x => x.trim()).filter(x => x);
    const headline = lineas[0] || "T√≠tulo del afiche";
    const texto = lineas[1] || "Texto secundario";
    const cta = lineas[lineas.length - 1] || "¬°Compra ahora!";
    const estilo = "moderno, profesional, colores atractivos";

    const res = await fetch("http://localhost:4000/api/crear-afiche-imagen", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ headline, texto, cta, estilo })
    });

    const data = await res.json();

    mensaje.style.display = "none"; // ocultar mensaje cuando llegue la respuesta

    if (data.ok) {
        const imgBox = document.getElementById("imagen-afiche");
        const img = document.getElementById("img-resultado");
        const btnDescargar = document.getElementById("btn-descargar");

        img.src = data.image;            
        btnDescargar.href = data.image;  

        imgBox.style.display = "block";
    }
    console.log("Respuesta backend:", data);
});

</script>

</body>
</html>
