<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargar Datos – AI Marketing Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --blue-1: #03045E;
            --blue-2: #0077B6;
            --blue-3: #00B4D8;
            --blue-4: #90E0EF;
            --blue-5: #CAF0F8;
        }

        body {
            font-family: "Poppins", sans-serif;
            background-color: var(--blue-5);
            overflow-x: hidden;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--blue-1);
            color: white;
            padding: 30px 20px;
        }

        .sidebar h2 {
            font-weight: 600;
            margin-bottom: 40px;
            text-align: center;
        }

        .sidebar-item {
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .sidebar-item:hover {
            background: var(--blue-3);
        }
        .content {
            margin-left: 320px;
            padding: 40px;
        }

        .upload-area {
            border: 2px dashed var(--blue-2);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: .3s;
            background: white;
        }

        .upload-area:hover {
            background: var(--blue-4);
        }

        .upload-area.dragover {
            background: var(--blue-4);
            border-color: var(--blue-1);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>AI Marketing</h2>

        <div class="sidebar-item" onclick="window.location.href='../dashboard.html'">
            Dashboard
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="content">
        <h2 class="fw-bold mb-4" style="color: var(--blue-1);">Cargar Datos a la Base</h2>

        <div class="card shadow-sm p-4" style="border-radius: 20px;">
            <h4 class="fw-bold mb-4" style="color:var(--blue-1);">Seleccione parámetros de carga</h4>

            <!-- Selección de colección -->
            <div class="mb-3">
                <label class="fw-bold mb-2">Seleccionar colección destino</label>
                <select id="coleccion" class="form-select">
                    <option value="">Seleccione...</option>
                    <option value="Productos">Productos</option>
                    <option value="Clientes">Clientes</option>
                    <option value="Transacciones">Transacciones</option>
                    <option value="Interacciones">Interacciones</option>
                    <option value="Comentarios">Comentarios</option>
                </select>
            </div>

            <!-- Drag & Drop -->
            <div id="uploadArea" class="upload-area mb-3">
                <h5 class="fw-bold mb-2" style="color:var(--blue-2);">Arrastra tu archivo aquí</h5>
                <p class="mb-0">Formatos permitidos: <strong>CSV o JSON</strong></p>
            </div>

            <!-- Input de archivo -->
            <input type="file" id="archivo" accept=".csv,.json" class="form-control mb-3">

            <!-- Nombre del archivo -->
            <div id="fileName" class="text-center fw-bold text-success mb-3"></div>

            <!-- Botón de subir -->
            <button id="btnSubir" onclick="subirArchivo()" 
                class="btn w-100 py-2 fw-bold text-white"
                style="background: var(--blue-2); border:none;">
                Subir archivo
            </button>

            <div id="resultado" class="mt-3"></div>
        </div>
    </div>

    <!-- JS -->
    <script>
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("archivo");
        const fileNameDisplay = document.getElementById("fileName");
        const resultado = document.getElementById("resultado");
        const btnSubir = document.getElementById("btnSubir");

        uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
            uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("dragover");

            const file = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            fileNameDisplay.textContent = "Archivo seleccionado: " + file.name;
        });

        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (file) fileNameDisplay.textContent = "Archivo seleccionado: " + file.name;
        });

        async function subirArchivo() {
            const coleccion = document.getElementById("coleccion").value;
            const archivo = fileInput.files[0];

            resultado.innerHTML = "";

            if (!coleccion) {
                resultado.innerHTML = '<div class="alert alert-danger">Seleccione una colección.</div>';
                return;
            }

            if (!archivo) {
                resultado.innerHTML = '<div class="alert alert-danger">Seleccione un archivo CSV o JSON.</div>';
                return;
            }

            btnSubir.disabled = true;
            btnSubir.innerText = "Subiendo...";

            const formData = new FormData();
            formData.append("file", archivo);
            formData.append("coleccion", coleccion);

            try {
                const res = await fetch("http://localhost:4000/api/upload-json", {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();

                resultado.innerHTML = `
                    <div class="alert ${data.ok ? 'alert-success' : 'alert-danger'}">
                        ${data.msg}
                        ${data.inserted ? `<br>Registros insertados: ${data.inserted}` : ""}
                    </div>
                `;

                if (data.ok) {
                    fileInput.value = "";
                    fileNameDisplay.innerText = "";
                    document.getElementById("coleccion").value = "";
                }

            } catch (error) {
                resultado.innerHTML = '<div class="alert alert-danger">Error al conectar con el servidor.</div>';
            }

            btnSubir.disabled = false;
            btnSubir.innerText = "Subir archivo";
        }
    </script>

</body>
</html>
