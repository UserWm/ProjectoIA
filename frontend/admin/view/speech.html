<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Speeches de Ventas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family: Poppins, sans-serif; background: #CAF0F8; }
.sidebar { position: fixed; left: 0; top: 0; width: 300px; height: 100vh; background: #03045E; color: white; padding: 25px; overflow-y: auto; }
.sidebar-item { padding: 10px 15px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px; cursor:pointer; transition:0.2s; }
.sidebar-item:hover { background: #0077B6; }
.content { margin-left: 330px; padding: 30px; }
#resultado { background:white; border-radius:14px; min-height:100px; border:1px solid #90E0EF; padding:20px; white-space:pre-wrap; line-height:1.6; }
</style>
</head>

<body>

<div class="sidebar">
    <div class="sidebar-item" onclick="window.location.href='../dashboard.html'">Dashboard</div>
    <hr>
    <h2 class="fw-bold mb-4">Historial</h2>
    <div id="historial-list"></div>
</div>

<div class="content">
<h2 class="fw-bold mb-4" style="color:#03045E;">Generador de Speeches de Ventas</h2>

<div class="card p-4 shadow-sm" style="border-radius:18px">
    <div class="row g-4">

        <div class="col-md-6">
            <label class="fw-bold mb-1">Producto</label>
            <select id="select-productos" class="form-select">
                <option value="">Cargando...</option>
            </select>
        </div>

        <div class="col-md-6">
            <label class="fw-bold mb-1">Tipo de Cliente</label>
            <select id="tipo-cliente" class="form-select">
                <option value="General">General</option>
                <option value="Premium">Premium</option>
                <option value="Empresas">Empresas</option>
            </select>
        </div>

        <div class="col-12">
            <label class="fw-bold mb-1">Requerimientos adicionales</label>
            <textarea id="descripcion" rows="4" class="form-control"></textarea>
        </div>

    </div>

    <hr>
    <div id="resultado" class="mt-4" style="display:none;"></div>
    <br>
    <button id="btn-generar" class="btn text-white" style="background:#0077B6">Generar Speech</button>
    <br>
    <button id="btn-descargar" class="btn text-white" style="background:#90E0EF;color:#03045E; display:none;">Descargar PDF</button>
</div>
</div>

<script type="module">
document.addEventListener("DOMContentLoaded", async () => {
    // Cargar productos
    const select = document.getElementById("select-productos");
    const res = await fetch("http://localhost:4000/api/productos");
    const productos = await res.json();
    select.innerHTML = "<option value=''>Seleccione...</option>";
    productos.forEach(p => select.innerHTML += `<option value="${p.nombre}" data-precio="${p.precio || ''}">${p.nombre}</option>`);

    // Cargar historial
    const cont = document.getElementById("historial-list");
    const resultado = document.getElementById("resultado");
    const resHist = await fetch("http://localhost:4000/api/speech");
    const historial = await resHist.json();
    if (!historial.length) cont.innerHTML = "<p class='text-white-50'>Sin historial</p>";
    historial.forEach(item => {
        const resumen = JSON.stringify(item.busqueda).slice(0, 40) + "...";
        const div = document.createElement("div");
        div.className = "sidebar-item";
        div.innerHTML = `<strong>Speech</strong><br><small>${resumen}</small>`;
        div.addEventListener("click", () => {
            resultado.style.display = "block";
            mostrarTextoAnimado(item.resultado);
            // Botón descargar PDF
            const btnDescargar = document.getElementById("btn-descargar");
            btnDescargar.style.display = "inline-block";
            btnDescargar.onclick = async () => {
                const resPdf = await fetch("http://localhost:4000/api/speech/descargar", {
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body: JSON.stringify({ speechText:item.resultado, producto:JSON.parse(item.busqueda).producto })
                });
                const blob = await resPdf.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.setAttribute("download", `speech-${JSON.parse(item.busqueda).producto}.pdf`);
                document.body.appendChild(link);
                link.click();
                link.remove();
            };
        });
        cont.appendChild(div);
    });
});

// Función para mostrar texto letra por letra
function mostrarTextoAnimado(texto) {
    const resultado = document.getElementById("resultado");
    resultado.innerText = "";
    let i = 0;
    function escribir() {
        if (i < texto.length) {
            resultado.innerText += texto.charAt(i);
            i++;
            setTimeout(escribir, 20);
        }
    }
    escribir();
}

// Generar speech
document.getElementById("btn-generar").addEventListener("click", async () => {
    const select = document.getElementById("select-productos");
    const producto = select.value;
    const precio = select.selectedOptions[0].dataset.precio || "";
    const tipoCliente = document.getElementById("tipo-cliente").value;
    const descripcion = document.getElementById("descripcion").value;

    if (!producto) return alert("Seleccione un producto");

    const filtros = { producto, tipoCliente, descripcion, precio };

    const resultado = document.getElementById("resultado");
    resultado.style.display = "block";
    resultado.innerText = "Generando contenido... ⏳";

    const res = await fetch("http://localhost:4000/api/speech/generar", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(filtros)
    });

    const data = await res.json();
    if (!data.ok) {
        resultado.innerText = "Error generando speech ❌";
        return;
    }

    mostrarTextoAnimado(data.resultado);

    // Mostrar botón PDF
    const btnDescargar = document.getElementById("btn-descargar");
    btnDescargar.style.display = "inline-block";
    btnDescargar.onclick = async () => {
        const resPdf = await fetch("http://localhost:4000/api/speech/descargar", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ speechText: data.resultado, producto })
        });
        const blob = await resPdf.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", `speech-${producto}.pdf`);
        document.body.appendChild(link);
        link.click();
        link.remove();
    };
});
</script>

</body>
</html>
